---
title: "v3.4"
author: "Steven N. Hart, Ph.D"
date: '9/30/2019'
output:
  html_document:
    keep_md: true
---

<style type="text/css">
.main-container {
  max-width: 1800px;
  margin-left: auto;
  margin-right: auto;
}
</style>




```r
all_annotations = read.csv('sources/v3.4a.out',header=TRUE, stringsAsFactors = FALSE, sep="\t")

#Get BayesDel
bd = read.csv('sources/BayesDel_nsfp33a_noAF.tsv',header=TRUE, sep="\t", skip = 132)
bd$ID=NULL

names(bd) =c("Chr", "Pos", "Ref", "Alt", "BayesDel")
all_annotations = merge(all_annotations, bd, all.x=TRUE)
rm(bd)

#Get AlignGVGD
agvgd = read.csv('sources/alignGvgd.tsv', header=TRUE, sep="\t", stringsAsFactors = FALSE)
names(agvgd) =c("Chr", "Pos", "Ref", "Alt", "AlignGVGDPrior")
all_annotations = merge(all_annotations, agvgd, all.x=TRUE)
rm(agvgd)


for (j in names(all_annotations)[6:ncol(all_annotations)]){
    if (typeof(all_annotations[,j]) == 'character'){
      # Get the maximum score
      all_annotations[,j] = suppressWarnings(sapply(strsplit(all_annotations[,j], "\\|"), function(x) (max(as.numeric(x),na.rm = TRUE))) %>% as.numeric())
      # Remove -Inf
      all_annotations[which(all_annotations[,j] =='-Inf'),j] = NA
    }
}
######################################################
# Add my own AAPos Annotations
b1=read.csv('sources/CAVA_BRCA1.txt', header = FALSE, sep='\t', stringsAsFactors = FALSE)
b2=read.csv('sources/CAVA_BRCA2.txt', header = FALSE, sep='\t', stringsAsFactors = FALSE)
b3 = rbind(b1,b2)
names(b3) = c('CSN','Gene','Variant','ProtChange','RefProt','AApos','AltProt')
b3 = b3[,c('Gene','Variant','AApos')]
b3$AApos = as.numeric(b3$AApos)
all_annotations = all_annotations %>%
  mutate(Variant = paste(Chr,Pos,Ref,Alt,sep='_'), AApos=NULL)
all_annotations = merge(all_annotations, b3, by="Variant", all.x=TRUE)
######################################################


all_annotations = all_annotations %>%
  filter(AApos>0)

keep = names(all_annotations)[-grep("Rankscore",names(all_annotations))]
all_annotations = all_annotations[,keep]

rm(keep, j)
#glimpse(all_annotations)
```

Plot all predictions


Set some useful functions

```r
# Create a filter to remove anything not in the BRCT/RING domains of BRCA1 and the DNA binding domain of BRCA2
filter_to_target_regions = function(d, variant_search = FALSE, l = links)
{
  RING_prot = c(1, 109)
  BRCT_prot = c(1642, 1855)
  DNABD_prot = c(2479, 3192)
  
  if(variant_search == TRUE){
    d$Variant = as.character(d$Variant)
    d = merge(d, l)
  }
  
  #Filter BRCA1 variants
  d$X.CHROM = as.numeric(d$X.CHROM)
  d$AApos   = as.numeric(d$AApos)
  BRCA1_keep_idx = which(
    d$X.CHROM ==  17 & (
      dplyr::between(d$AApos, RING_prot[1], RING_prot[2]) | dplyr::between(d$AApos,BRCT_prot[1], BRCT_prot[2]) 
      )
  )
  
  BRCA2_keep_idx =  which(d$X.CHROM ==  13 & dplyr::between(d$AApos, DNABD_prot[1], DNABD_prot[2]))
  d = d[c(BRCA1_keep_idx,BRCA2_keep_idx),]
  d = distinct(d, Variant, .keep_all = TRUE)
  rm(RING_prot, BRCT_prot, DNABD_prot, BRCA1_keep_idx, BRCA2_keep_idx)
  return(d)
}


### Define the MCC function
mcc <- function(predicted, actual)
{
  TP <- sum(actual ==   "Damaging" & predicted ==   "Damaging")
  TN <- sum(actual ==   "Neutral"     & predicted ==   "Neutral")
  FP <- sum(actual ==   "Neutral"     & predicted ==   "Damaging")
  FN <- sum(actual ==   "Damaging" & predicted ==   "Neutral")
  mcc <- ((TP*TN) - (FP*FN)) / sqrt((as.numeric(TP + FP)*as.numeric(TP + FN)*as.numeric(TN + FP)*as.numeric(TN + FN)))
  rm(TP, TN, FP, FN)
  return(round(mcc, digits = 3))
}

  

links = all_annotations %>% 
  mutate(Variant = paste(Chr,Pos, Ref, Alt, sep = "_")) %>%
  mutate(X.CHROM=Chr, POS=Pos, REF=Ref, ALT=Alt) %>%
  select(X.CHROM, AApos, Variant )
```



Load all functional data

```r
#Read in our data
neutral_list = read.csv("sources/neutral.list",sep = "\t",header = FALSE, stringsAsFactors = FALSE)
damaging_list = read.csv("sources/deleterious.list",sep = "\t",header = FALSE, stringsAsFactors = FALSE)

Hart_df = rbind(neutral_list,damaging_list)
names(Hart_df) = c("Gene","Variant","Call", "Source")

Hart_df = filter_to_target_regions(Hart_df, variant_search = TRUE)

rm(neutral_list, damaging_list)


# Read in annotations from CAVA
CAVA_BRCA1 = read.csv('sources/CAVA_BRCA1.txt',header = FALSE,
                   sep = "\t", stringsAsFactors = FALSE, 
                   na.strings = c('.'))
names(CAVA_BRCA1)=c('CSN','Gene','cpra','variantID', 'refAA','AApos', 'altAA')

# Read in annotations from CAVA
CAVA_BRCA2 = read.csv('sources/CAVA_BRCA2.txt',header = FALSE,
                   sep = "\t", stringsAsFactors = FALSE, 
                   na.strings = c('.'))
names(CAVA_BRCA2)=c('CSN','Gene','cpra','variantID', 'refAA','AApos', 'altAA')
```


```r
#######################################################################################################################################
#Read in Starita
#Get data
HDR_damaging_max = 0.33
HDR_neutral_min = 0.77

# Update 05/26/2019: Start from Startia et al Table S7, as an input
Starita = read.csv('sources/StaritaST7.tsv.txt',header = TRUE,
                   sep = "\t", stringsAsFactors = FALSE, 
                   na.strings = c('.'))

# Need to merge annotations so I can cross-reference
Starita = merge(Starita, CAVA_BRCA1, by='variantID')
# Remove duplicate variants
Starita = Starita %>%
  select(Starita_HDR_predict, variantID, cpra) %>%
  unique()
Starita$HDR=as.numeric(Starita$Starita_HDR_predict)

Starita = Starita %>%
  filter(HDR <=   HDR_damaging_max | HDR >=  HDR_neutral_min)



Starita_df = data.frame(
  Variant = as.character(Starita$cpra),
  Gene = 'BRCA1',
  Call = ifelse(Starita$HDR <=  HDR_damaging_max, "Damaging", 'Neutral' )
)
Starita_df = na.omit(Starita_df)

Starita_df = Starita_df %>%
  select(Gene, Variant, Call) %>%
  mutate(Source = "Starita et al., 2015") %>%
  unique()

Starita_df    = filter_to_target_regions(Starita_df, variant_search = TRUE)

rm(Starita, HDR_damaging_max, HDR_neutral_min)
```



```r
#######################################################################################################################################
#Read in Fernandes
#Get data
Fernandes = read.csv('sources/Fenandez.tsv', header = TRUE, 
                     sep = "\t", stringsAsFactors = FALSE)
#Remove WT and splic variants
omit = Fernandes$variant[grep('del|\\+|WT|\\/|ins',Fernandes$variant)]

Fernandes = Fernandes %>%
  filter(!variant %in% omit) %>%
  filter(IARC %in% c(0,1,4,5)) %>%
  mutate(Call = ifelse(IARC > 2, "Damaging", "Neutral"), Gene = 'BRCA1') %>%
  select(Gene, Variant, Call) %>%
  mutate(Source = "Fernandes et al., 2019") %>%
  unique()

Fernandes_df    = filter_to_target_regions(Fernandes, variant_search = TRUE)

rm(Fernandes, omit)
```


```r
#######################################################################################################################################
#Read in Findlay
#Get data

# Update 05/26/2019: Start from Findlay et al Table S1, as an input

Findaly = read.csv('sources/Findlay_ST1.txt', header = TRUE,sep = "\t", 
                   stringsAsFactors = FALSE, na.strings = c('','NA','.'))
Findaly = Findaly %>% 
  mutate(cpra=paste(chromosome,`position..hg19.`,reference,alt,sep="_" ))
# Merge with annotations
Findaly = merge(Findaly, CAVA_BRCA1, by='cpra')


# Exclude splicing (1/28)
Findaly = Findaly %>%
  filter(consequence=='Missense', func.class %in% c('FUNC','LOF')) 

AlreadySeen = c(Fernandes_df$Variant, Starita_df$Variant)
Findaly$AlreadySeen = as.numeric(Findaly$cpra %in% AlreadySeen)

Fin_df = data.frame(
  Gene = Findaly$Gene,
  Variant = Findaly$cpra,
  Call = Findaly$func.class,
  Score = Findaly$function.score.mean,
  Seen = Findaly$AlreadySeen)

Findlay_df = Fin_df %>%
  filter(Seen ==  0)

Findlay_df$Call =  ifelse(Findlay_df$Call ==  'FUNC', 'Neutral', 'Damaging')

Findlay_df = Findlay_df %>%
  select(Gene, Variant, Call) %>%
  mutate(Source = "Findlay et al., 2018") %>%
  unique()

Findlay_df = filter_to_target_regions(Findlay_df, variant_search = TRUE)

rm(Fin_df, Findaly)
```


```r
#######################################################################################################################################
# Combine experimental datasets
experimental_data = rbind(Hart_df, Fernandes_df, Starita_df, Findlay_df)
d = as.data.frame(table(experimental_data$Gene, experimental_data$Call, experimental_data$Source))
names(d) = c('Gene', 'Call', 'Source', 'RawCount')

experimental_data = distinct(experimental_data, Gene, Variant, .keep_all = TRUE)
e = as.data.frame(table(experimental_data$Gene, experimental_data$Call, experimental_data$Source))
names(e) = c('Gene', 'Call', 'Source', 'FilteredCount')

Counts = cbind(d, e$FilteredCount)
names(Counts)[length(names(Counts))] = 'FilteredCount'


rm(Hart_df, Fernandes_df, Starita_df, Findlay_df)
table(experimental_data$Source, experimental_data$Call,experimental_data$Gene)
```

```
## , ,  = BRCA1
## 
##                         
##                          Damaging Neutral
##   Fernandes et al., 2019        0     116
##   Findlay et al., 2018        329    1232
##   Guidugli et al., 2014         0       0
##   Guidugli et al., 2018         0       0
##   Hart et al, 2018              2      11
##   Lee et al., 2010             52      36
##   Lindor et al., 2012           0       0
##   Starita et al., 2015         11      77
##   This paper                    0       0
##   Woods et al., 2016            7      18
## 
## , ,  = BRCA2
## 
##                         
##                          Damaging Neutral
##   Fernandes et al., 2019        0       0
##   Findlay et al., 2018          0       0
##   Guidugli et al., 2014         4       0
##   Guidugli et al., 2018        38      48
##   Hart et al, 2018             16      47
##   Lee et al., 2010              0       0
##   Lindor et al., 2012           9      18
##   Starita et al., 2015          0       0
##   This paper                    7      15
##   Woods et al., 2016            0       0
```

```r
table(experimental_data$Call,experimental_data$Gene)
```

```
##           
##            BRCA1 BRCA2
##   Damaging   401    74
##   Neutral   1490   128
```

More custom functions


```r
prepare_inputs = function(data = experimental_data, 
                          annotations = all_annotations, 
                          gene = 'BRCA1', 
                          sources = NULL){

  s = NULL

  if ('Hart' %in% sources){s = c("This paper", "Guidugli et al., 2018", 
                                 "Hart et al, 2018", "Lee et al., 2010",
                                 "Lindor et al., 2012", "Woods et al., 2016", 
                                  "Guidugli et al., 2014")}
  if ('Fernandes' %in% sources){s = c(s, 'Fernandes et al., 2019')}
  if ('Starita' %in% sources){s = c(s, 'Starita et al., 2015')}
  if ('Findlay' %in% sources){s = c(s, 'Findlay et al., 2018')}
  
  # if sources = PATH, then take all pathogenic variants from all studies and benign from our study
  if(is.null(s)){
    data = data %>%
      filter(Gene == gene)
  }else{
    # Filter to known results for a specific gene
    data = data %>%
      filter(Source %in% s, Gene == gene)
  }
  
  data = distinct(data, Gene, Variant, .keep_all = TRUE)
  
  #Merge to get annotations
  data = merge(data,
    annotations,
    all.x = TRUE,
    by = 'Variant')
  
  # Sort list randomly
  data = sample(data)
  if ('Gene.x' %in% names(data)){ data = data %>% mutate(Gene = Gene.x, Gene.x=NULL, Gene.y=NULL)}
  if ('AApos.x' %in% names(data)){ data = data %>% mutate(AApos = AApos.x, AApos.x=NULL, AApos.y=NULL)}
  if ('X.CHROM.x' %in% names(data)){ data = data %>% mutate(X.CHROM = X.CHROM.x, X.CHROM.x=NULL, X.CHROM.y=NULL)}
  return(data)
}

split_data = function(known_scores, validation_fraction = 0.2 ){
  set.seed(999)
  known_scores$Call = as.factor(known_scores$Call)
  num_predictions = nrow(known_scores)

  #Create training testing and validation
  Neutral_idx = which(known_scores$Call == 'Neutral')
  Damaging_idx = which(known_scores$Call == 'Damaging')
  
  n_train_idx = sample(Neutral_idx, size = length(Neutral_idx) * 0.8)
  d_train_idx = sample(Damaging_idx, size = length(Damaging_idx) * 0.8)

  # Subset to training and validation
  idx = c(n_train_idx, d_train_idx)
  #Shuffle randomly
  idx = sample(idx)
  
  train_t = known_scores[idx,]
  test_t = known_scores[-idx,]
  splits = NULL
  splits$test = NULL
  splits$train = NULL
  splits$train = train_t
  splits$test = test_t
  return(splits)
}



k_fold_split_data = function(known_scores, k=10 ){
  set.seed(999)
  known_scores$Call = as.factor(known_scores$Call)
  num_predictions = nrow(known_scores)
  
  #Create training testing and validation
  Neutral_idx = which(known_scores$Call == 'Neutral')
  Neutral_fold = createFolds(Neutral_idx, k = k, list = FALSE)
  Damaging_idx = which(known_scores$Call == 'Damaging')
  Damaging_fold = createFolds(Damaging_idx, k = k, list = FALSE)
  
  
  # Subset to training and validation
  idx_f = c(Neutral_fold, Damaging_fold)
  
  known_scores$Fold = idx_f
  
  splits = sample(known_scores)
  return(splits)
}


train_model = function(splits, k_=NULL, Gene = 'BRCA1'){
  knitr::opts_chunk$set(echo=FALSE)

  h2o.init(min_mem_size = "8g", max_mem_size = "12g", nthreads = 10)
  
  train_ = as.h2o(splits$train)
  
  all_h2o_models =  h2o.automl(x = COLUMNS, y = "Call",
                  training_frame = train_,
                  keep_cross_validation_predictions = TRUE,
                  keep_cross_validation_models=TRUE,
                  keep_cross_validation_fold_assignment=TRUE,
                  nfolds = 5,
                  max_runtime_secs = training_time_limit,
                  sort_metric = 'mean_per_class_error',
                  stopping_metric = 'mean_per_class_error',
                  seed = 100)
  knitr::opts_chunk$set(echo=TRUE)
  
  #Save the model
  best_model = h2o.saveModel(object = all_h2o_models@leader,path = "results/",force = TRUE)
  best_model
  cv_predictions = h2o.getFrame(all_h2o_models@leader@model[["cross_validation_holdout_predictions_frame_id"]][["name"]])
  cv_groups = h2o.getFrame(all_h2o_models@leader@model[["cross_validation_fold_assignment_frame_id"]][["name"]])
  # Load model
  model_out = h2o.loadModel(best_model)
  model_vi  = as.data.frame(all_h2o_models@leader@model$variable_importances)
  threshold = h2o.find_threshold_by_max_metric(h2o.performance(model_out), 'absolute_mcc')
  my_list   = list('all_h2o_models' = all_h2o_models, 'best_model' = best_model, 
                   'model' = model_out, 'vi' =  model_vi, 'threshold' = threshold, 
                   'cv_predictions' = as.data.frame(cv_predictions), cv_groups = as.data.frame(cv_groups))
  return(my_list)
  }


test_model = function(splits, model, threshold = NULL){

  knitr::opts_chunk$set(echo=FALSE)
  h2o.init(min_mem_size = "16g", max_mem_size = "32g", nthreads = 1)

  test = as.h2o(splits$test)
  
  pred = h2o.predict(model, 
                     newdata = test, 
                     threshold = threshold)
  knitr::opts_chunk$set(echo=TRUE)

  pred = as.data.frame(pred)

  #Edit prediction based on previous threshold
  final_result = cbind(splits$test, pred)

  cm = confusionMatrix(final_result$predict,final_result$Call, positive = 'Damaging')
  m = mcc(final_result$predict,final_result$Call)
  my_list = list('result' = final_result, 'cm' = cm, 'MCC' = m)
  return(my_list)
}

apply_model_to_gene = function(model = model, threshold = threshold,
                               gene = 'BRCA1', annotations = all_annotations){
  #Run model on each gene
  tmp = annotations %>%
    filter(Genename == gene)
  pred = h2o.predict(model, newdata = as.h2o(tmp), threshold = threshold)
  pred = as.data.frame(pred)
  tmp$Prediction = pred$predict
  tmp$`BRCA-ML` = pred$Damaging
  tmp$Neut = pred$Neutral
  return(tmp)
}


plot_full_gene = function(data, title, splits = splits, model_name='BRCA-ML', t_=NULL){
  
  #Pull out training, validation, & testing variants to plot
  
  if(length(splits$train)){
    variants = splits$train %>%
      select(AApos, Call)
    
  
    variants = rbind(variants,splits$test %>%
      select(AApos, Call)
    )  
  }else{
    variants = NULL
  }
  
  tmp = data[,c("Genename","BRCA-ML","AApos","Prediction")]
  tmp$Model = model_name
  names(tmp) = c("Gene","Score","AApos","Prediction","Model")
  tmp$Prediction = as.character(tmp$Prediction)
  if (!is.null(t_)){tmp = tmp %>% mutate(Prediction = ifelse(Score > t_, 'Damaging', 'Neutral'))}
  p = tmp %>%
    ggplot(aes(x = AApos,y = Score, colour = Prediction)) +
    geom_point(size = 0.2) +
    #facet_grid(Model ~ Gene, scales = 'free') +
    geom_smooth(aes(x = AApos,y = Score), inherit.aes = FALSE) +
    ggtitle(title) +
    theme(legend.position="none") 
  if(length(splits$train)){
    p = p + geom_rug(
        aes(x=AApos, colour=Call, alpha = 1/2), 
        inherit.aes = FALSE, 
        sides = "b", 
        data = variants)
  }
  return(p)
}
```


```r
  get_cv_estimate = function(gene='BRCA1'){
    h2o.init(min_mem_size = "8g", max_mem_size = "10g", nthreads = 36)
    # Nested cross validation of the "pick the leader" process
    #bx_input = b1_DATA_SPLITS$train
    if (gene == 'BRCA1'){
      bx_input = b1_DATA_SPLITS$train
    }else{
      bx_input = b2_DATA_SPLITS$train
    }
    bx_DATA_SPLITS = k_fold_split_data(bx_input, k = v_fold_nest)  # change to k-fold CV, 2020-05-28
    
    preds = NULL
    for(v in 1:v_fold_nest) {
        train_v <- bx_DATA_SPLITS[which(bx_DATA_SPLITS$Fold != v), ]
        test_v <- bx_DATA_SPLITS[which(bx_DATA_SPLITS$Fold == v), ]
        
        train = as.h2o(train_v)
        all_h2o_models = h2o.automl(x = COLUMNS, y = "Call",
                        training_frame = train,
                        keep_cross_validation_predictions = FALSE, # don't need these
                        nfolds = 5,  # should be increased to 10?
                        max_runtime_secs = training_time_limit,
                        algo_parameters = list(list(min_rows=-1)),
                        sort_metric = 'mean_per_class_error',
                        stopping_metric = 'mean_per_class_error',
                        seed = 100)
        test = as.h2o(test_v)
        pred = h2o.predict(all_h2o_models@leader, newdata = test)
        pred= as.data.frame(pred)
        pred = cbind(pred, test_v)
        preds = rbind(preds, pred)

        write.csv(preds, file=paste0('results/', gene,'_res.fold',v,'.csv'))
    }
    return(preds)
  }
```

Define columns to TRAIN on


```r
models = read.csv('sources/base_thresholds', header = FALSE, sep="\t", stringsAsFactors = FALSE)
COLUMNS = models$V1
```

Prepare inputs for the training

```r
#BRCA1
b1_input = prepare_inputs(gene = 'BRCA1')
b1_DATA_SPLITS = split_data(b1_input)

b2_input = prepare_inputs(gene = 'BRCA2')
b2_DATA_SPLITS = split_data(b2_input)
```

Calculate nested cross validation metrics

```r
#Add in metrics from our current model
if (train==TRUE){
  b1_cv = get_cv_estimate(gene = 'BRCA1') # WARNING! THIS TAKES AN EXTREMELY LONG TIME!!
  b2_cv = get_cv_estimate(gene = 'BRCA2') # WARNING! THIS TAKES AN EXTREMELY LONG TIME!!
} else{
  for (v in 1:v_fold_nest){
    b1_cv = NULL
    b2_cv = NULL
    b1 = read.csv(paste0('results/','BRCA1_res.fold',v,'.csv'))
    b1_cv = rbind(b1_cv, b1)
    b2 = read.csv(paste0('results/','BRCA2_res.fold',v,'.csv'))
    b2_cv = rbind(b2_cv, b2)
    b1_cv = na.omit(b1_cv)
    b2_cv = na.omit(b2_cv)
  }
}
```

Train

```
##  Connection successful!
## 
## R is connected to the H2O cluster: 
##     H2O cluster uptime:         2 days 53 minutes 
##     H2O cluster timezone:       America/Chicago 
##     H2O data parsing timezone:  UTC 
##     H2O cluster version:        3.30.0.1 
##     H2O cluster version age:    3 months and 4 days  
##     H2O cluster name:           H2O_started_from_R_Steven_mzd115 
##     H2O cluster total nodes:    1 
##     H2O cluster total memory:   3.40 GB 
##     H2O cluster total cores:    8 
##     H2O cluster allowed cores:  8 
##     H2O cluster healthy:        TRUE 
##     H2O Connection ip:          localhost 
##     H2O Connection port:        54321 
##     H2O Connection proxy:       NA 
##     H2O Internal Security:      FALSE 
##     H2O API Extensions:         Amazon S3, Algos, AutoML, Core V3, TargetEncoder, Core V4 
##     R Version:                  R version 3.6.3 (2020-02-29)
```

```
##  Connection successful!
## 
## R is connected to the H2O cluster: 
##     H2O cluster uptime:         2 days 53 minutes 
##     H2O cluster timezone:       America/Chicago 
##     H2O data parsing timezone:  UTC 
##     H2O cluster version:        3.30.0.1 
##     H2O cluster version age:    3 months and 4 days  
##     H2O cluster name:           H2O_started_from_R_Steven_mzd115 
##     H2O cluster total nodes:    1 
##     H2O cluster total memory:   3.40 GB 
##     H2O cluster total cores:    8 
##     H2O cluster allowed cores:  8 
##     H2O cluster healthy:        TRUE 
##     H2O Connection ip:          localhost 
##     H2O Connection port:        54321 
##     H2O Connection proxy:       NA 
##     H2O Internal Security:      FALSE 
##     H2O API Extensions:         Amazon S3, Algos, AutoML, Core V3, TargetEncoder, Core V4 
##     R Version:                  R version 3.6.3 (2020-02-29) 
## 
##   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |   0%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |==============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================| 100%
##   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |   0%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |==============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================| 100%
```

```
##   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |   0%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |==============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================| 100%
##   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |   0%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |==============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================| 100%
```


```
##  Connection successful!
## 
## R is connected to the H2O cluster: 
##     H2O cluster uptime:         2 days 53 minutes 
##     H2O cluster timezone:       America/Chicago 
##     H2O data parsing timezone:  UTC 
##     H2O cluster version:        3.30.0.1 
##     H2O cluster version age:    3 months and 4 days  
##     H2O cluster name:           H2O_started_from_R_Steven_mzd115 
##     H2O cluster total nodes:    1 
##     H2O cluster total memory:   3.40 GB 
##     H2O cluster total cores:    8 
##     H2O cluster allowed cores:  8 
##     H2O cluster healthy:        TRUE 
##     H2O Connection ip:          localhost 
##     H2O Connection port:        54321 
##     H2O Connection proxy:       NA 
##     H2O Internal Security:      FALSE 
##     H2O API Extensions:         Amazon S3, Algos, AutoML, Core V3, TargetEncoder, Core V4 
##     R Version:                  R version 3.6.3 (2020-02-29) 
## 
##   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |   0%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |==============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================| 100%
##   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |   0%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |==============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================| 100%
##   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |   0%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |==============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================| 100%
##   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |   0%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |==============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================| 100%
##   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |   0%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |==============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================| 100%
##   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |   0%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |==============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================| 100%
##   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |   0%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |==============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================| 100%
##   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |   0%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |==============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================| 100%
##   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |   0%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |==============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================| 100%
##   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |   0%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |==============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================| 100%
##   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |   0%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |==============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================| 100%
##   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |   0%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |==============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================| 100%
##   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |   0%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |==============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================| 100%
##   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |   0%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |==============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================| 100%
##   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |   0%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |==============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================| 100%
##   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |   0%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |==============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================| 100%
##   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |   0%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |==============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================| 100%
##   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |   0%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |==============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================| 100%
##   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |   0%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |==============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================| 100%
##   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |   0%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |==============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================| 100%
```

```
##  Connection successful!
## 
## R is connected to the H2O cluster: 
##     H2O cluster uptime:         2 days 53 minutes 
##     H2O cluster timezone:       America/Chicago 
##     H2O data parsing timezone:  UTC 
##     H2O cluster version:        3.30.0.1 
##     H2O cluster version age:    3 months and 4 days  
##     H2O cluster name:           H2O_started_from_R_Steven_mzd115 
##     H2O cluster total nodes:    1 
##     H2O cluster total memory:   3.40 GB 
##     H2O cluster total cores:    8 
##     H2O cluster allowed cores:  8 
##     H2O cluster healthy:        TRUE 
##     H2O Connection ip:          localhost 
##     H2O Connection port:        54321 
##     H2O Connection proxy:       NA 
##     H2O Internal Security:      FALSE 
##     H2O API Extensions:         Amazon S3, Algos, AutoML, Core V3, TargetEncoder, Core V4 
##     R Version:                  R version 3.6.3 (2020-02-29) 
## 
##   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |   0%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |==============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================| 100%
##   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |   0%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |==============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================| 100%
```

```
##   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |   0%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |==============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================| 100%
##   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |   0%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |==============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================| 100%
```

Make functions to determine cutoff for other missense predictors


```r
get_res = function(input_data, model){
  
  ## Use the training data to get an optimal threshold
  
  # Make a df that merges the experimental results with predictors
  tmp = input_data$train[,c('Call',model)]
  roc_obj <- roc(tmp$Call, tmp[,model])
  d = as.data.frame(coords(roc_obj, "best", ret=c("threshold","sensitivity", "specificity", "tp", "tn", "fp", "fn")))
  threshold = unlist(d[1])
  if(is.null(threshold)){threshold=0.5}
  ################################################################################
  ## 05/28/20
  tmp$Model='Neutral'
  if (model %in% c("SiftScore")){
    tmp$Model = ifelse(tmp[,model]>threshold,'Neutral','Damaging')
  }else{
    tmp$Model = ifelse(tmp[,model]<threshold,'Neutral','Damaging')  
  }
  cm = confusionMatrix(as.factor(tmp$Model), as.factor(tmp$Call), positive="Damaging")
  tp=cm$table[1]
  fn=cm$table[2]
  fp=cm$table[3]
  tn=cm$table[4]
  sensitivity=cm$byClass[1]
  specificity=cm$byClass[2]
  # Add no call information
  missingness = (nrow(tmp)-sum(cm$table))/nrow(tmp) * 100
  d = data.frame(tp=tp,fp=fp,fn=fn,tn=tn,sensitivity=sensitivity,specificity=specificity, threshold=threshold, model=model, missingness=missingness)
  ################################################################################
  rownames(d)=NULL
  d = as.data.frame(d)
  d$mcc = ((d$tp*d$tn) - (d$fp * d$fn)) / sqrt((as.numeric(d$tp + d$fp)*as.numeric(d$tp + d$fn)*as.numeric(d$tn + d$fp)*as.numeric(d$tn + d$fn)))
  d$model = model
  pr_1 =NULL
  # Add precision recall
  
  idx = which(tmp$Call=='Neutral')
  tryCatch(
    {
      pr_1 = pr.curve(
              scores.class0 = tmp[-idx, model],
              scores.class1 = tmp[idx, model], 
              curve=TRUE, sorted = FALSE)
      
      
    },
    error = function(cond){
      pr_1 = NULL
    })
    
    if (is.null(pr_1)){
      proc = NULL
      proc$V1 = 0
      proc$V2 = 0
      proc$V3 = 0
      proc$Model = model
      d$PRauc = 0
    }else{
      d$PRauc = pr_1$auc.integral
      proc = pr_1$curve %>% as.data.frame()
      proc$Model = model
    }

  my_list = list('roc' = roc_obj, 'res' = d, 'proc' = proc)
  rm(d, tmp)
  return(my_list)
  
}

compute_optimal = function(input_data=b1_DATA_SPLITS){
  RES = NULL
  ROC = NULL
  PROC = NULL
  for (model in models$V1){
    l = get_res(input_data, model)
    RES = rbind(RES, l$res)
    d1 = data.frame(sensitivities=l$roc$sensitivities, specificities=l$roc$specificities, auc = as.numeric(l$roc$auc))
    d1$Model = model
    ROC = rbind(ROC, d1)
    
    # Add PROC
    tryCatch(
      {PROC = rbind(PROC, l$proc)},
      error = function(cond){
        PROC = PROC
      }
    )
  }
  my_list = list('RES' = RES, 'ROC' = ROC, 'PROC' = PROC)
  return(my_list)
}
```


Compute optimal for BRCA1

```r
res_roc_1 = compute_optimal(input_data=b1_DATA_SPLITS)
```


```r
# Get ROC/PROC curve for BRCA-ML on CV set
roc_obj <- roc(b1_cv$Call,b1_cv$Damaging)

# Get metrics from cv-set
cm = confusionMatrix(as.factor(b1_cv$Call), b1_cv$predict, positive="Damaging")
tp=cm$table[1]
fn=cm$table[2]
fp=cm$table[3]
tn=cm$table[4]
sensitivity=cm$byClass[1]
specificity=cm$byClass[2]
# Add no call information
missingness = (nrow(b1_DATA_SPLITS$train)-sum(cm$table))/nrow(b1_DATA_SPLITS$train) * 100
threshold = b1_TRAINED_DATA$threshold
model='BRCA-ML'
d = data.frame(tp=tp,fp=fp,fn=fn,tn=tn,sensitivity=sensitivity,specificity=specificity, threshold=threshold, model=model, missingness=missingness)
rownames(d)=NULL
d = as.data.frame(d)
d$mcc = ((d$tp*d$tn) - (d$fp * d$fn)) / sqrt((as.numeric(d$tp + d$fp)*as.numeric(d$tp + d$fn)*as.numeric(d$tn + d$fp)*as.numeric(d$tn + d$fn)))

# Add precision recall
idx = which(b1_cv$Call=='Neutral')
pr_1 = pr.curve(
  scores.class0 = b1_cv$Damaging[-idx],
  scores.class1 = b1_cv$Damaging[idx], 
  curve=TRUE,sorted = FALSE) 
d$PRauc = pr_1$auc.integral

res_roc_1$RES = rbind(res_roc_1$RES, d)

## Start getting curve info
d1 = data.frame(sensitivities=roc_obj$sensitivities, specificities=roc_obj$specificities, auc = as.numeric(roc_obj$auc))
d1$Model='BRCA-ML'

d2 = pr_1$curve %>% as.data.frame()
d2$Model = 'BRCA-ML'

res_roc_1$ROC = rbind(res_roc_1$ROC, d1)
res_roc_1$PROC = rbind(res_roc_1$PROC, d2)
rm(d,d1,d2, tmp)

p1 = res_roc_1$ROC %>%
  ggplot(aes(y=sensitivities, x=1-specificities, color = Model)) +
  geom_line() +
  scale_fill_brewer(palette="Paired") +
  labs(color='Model') +
  xlab("Specificity") +
  ylab("Sensitivity") +
  ggtitle('BRCA1') +
  theme(legend.position = "none")
```

Compute for BRCA2

```r
res_roc_2 = compute_optimal(input_data=b2_DATA_SPLITS)
```



```r
# Get ROC/PROC curve for BRCA-ML on CV set
roc_obj <- roc(b2_cv$Call, b2_cv$Damaging)

# Get metrics from test set 
cm = confusionMatrix(as.factor(b2_cv$Call), b2_cv$predict, positive="Damaging")
tp=cm$table[1]
fn=cm$table[2]
fp=cm$table[3]
tn=cm$table[4]
sensitivity=cm$byClass[1]
specificity=cm$byClass[2]
# Add no call information
missingness = (nrow(b2_TESTED_DATA$result)-sum(cm$table))/nrow(b2_TESTED_DATA$result) * 100
threshold = b2_TRAINED_DATA$threshold
model='BRCA-ML'
d = data.frame(tp=tp,fp=fp,fn=fn,tn=tn,sensitivity=sensitivity,specificity=specificity, threshold=threshold, model=model, missingness=missingness)
rownames(d)=NULL
d = as.data.frame(d)
d$mcc = ((d$tp*d$tn) - (d$fp * d$fn)) / sqrt((as.numeric(d$tp + d$fp)*as.numeric(d$tp + d$fn)*as.numeric(d$tn + d$fp)*as.numeric(d$tn + d$fn)))

# Add precision recall
idx = which(b2_cv$Call=='Neutral')
pr_2 = pr.curve(
  scores.class0 = b2_cv$Damaging[-idx],
  scores.class1 = b2_cv$Damaging[idx], 
  curve=TRUE,sorted = FALSE) 
d$PRauc = pr_2$auc.integral

res_roc_2$RES = rbind(res_roc_2$RES, d)

d1 = data.frame(sensitivities=roc_obj$sensitivities, specificities=roc_obj$specificities, auc = as.numeric(roc_obj$auc))
d1$Model='BRCA-ML'

d2 = pr_1$curve %>% as.data.frame()
d2$Model='BRCA-ML'


res_roc_2$ROC = rbind(res_roc_2$ROC, d1)
res_roc_2$PROC = rbind(res_roc_2$PROC, d2)
rm(d,d1,tmp)

p2 = res_roc_2$ROC %>%
  ggplot(aes(y=sensitivities, x=1-specificities, color = Model)) +
  geom_line() +
  scale_fill_brewer(palette="Paired") +
  labs(color='Model') +
  xlab("Specificity") +
  ylab("Sensitivity") +
  ggtitle('BRCA2') 
```


Make a combined image

```r
ggarrange(p1, p2,ncol=2, nrow=1, common.legend = TRUE, legend = "bottom")
```

![](BRCA_ML_files/figure-html/combine-p1-p2-1.png)<!-- -->

Make PR Curves

```r
res_roc_1$PROC$Gene='BRCA1'
res_roc_2$PROC$Gene='BRCA2'
PROC = rbind(res_roc_1$PROC, res_roc_2$PROC)

p3 = PROC %>% 
  filter(Gene == 'BRCA1') %>%
  ggplot(aes(x=V1, y=V2, color=Model)) + 
  geom_line() +
  facet_grid(. ~ Gene) +
  theme(legend.position = "none") +
  ylab('Precision') +
  xlab("Recall")

p4 = PROC %>% 
  filter(Gene == 'BRCA2') %>%
  ggplot(aes(x=V1, y=V2, color=Model)) + 
  geom_line() +
  facet_grid(. ~ Gene) +
  theme(legend.position = "right")+
  ylab('Precision') +
  xlab("Recall")
```

All together now.  This represent the performance on the cross validation data for BRCA-ML (overfit on  all others).

```r
figure = ggarrange(p1, p2, p3, p4, common.legend = TRUE, legend = "right" )
annotate_figure(figure, fig.lab ="Cross validation performance",fig.lab.size=18, fig.lab.face = 'bold', top = text_grob("", size = 14))
```

![](BRCA_ML_files/figure-html/plot-pr-1.png)<!-- -->

```r
ggsave(filename = "results/Combined_PROC_ROC.png", width = 14, height = 8, units = "in", dpi = 300)
```

Make pair plot

```r
tmp = b1_PREDICTIONS %>%
  select(AApos, `BRCA-ML`, BayesDel) %>%
  mutate(Gene='BRCA1')

tmp2 = b2_PREDICTIONS %>%
  select(AApos, `BRCA-ML`, BayesDel) %>%
  mutate(Gene='BRCA2')
 
tmp = rbind(tmp, tmp2)
tmp = tmp %>%
  gather(key = "Model", value = 'Value',  `BRCA-ML`:BayesDel)


## Assign damaging score
tmp$Prediction='Neutral'
idx1 = which(tmp$Gene == 'BRCA1' & tmp$Value >= b1_TRAINED_DATA$threshold & tmp$Model == 'BRCA-ML')
idx2 = which(tmp$Gene == 'BRCA2' & tmp$Value >= b2_TRAINED_DATA$threshold & tmp$Model == 'BRCA-ML')

bd_thresh = res_roc_1$RES %>% filter(model=='BayesDel') %>% select(threshold) %>% as.numeric()
idx3 = which(tmp$Gene == 'BRCA1' & tmp$Value >= bd_thresh & tmp$Model == 'BayesDel')
bd_thresh = res_roc_2$RES %>% filter(model=='BayesDel') %>% select(threshold) %>% as.numeric()
idx4 = which(tmp$Gene == 'BRCA2' & tmp$Value >= bd_thresh & tmp$Model == 'BayesDel')

tmp$Prediction[c(idx1,idx2,idx3,idx4)] = 'Damaging'
rm(idx1,idx2,idx3,idx4, bd_thresh)

tmp %>%
  ggplot(aes(x=AApos, y=Value, color=Prediction)) +
  geom_point(size=0.5) +
  geom_smooth(aes(x = AApos,y = Value), inherit.aes = FALSE) +
  facet_wrap(~Model+Gene, scales = "free", ncol=2) +
  theme(legend.position = "bottom")
```

![](BRCA_ML_files/figure-html/pair-plot-1.png)<!-- -->

```r
ggsave(filename = "results/PairPlot.png", width = 14, height = 8, units = "in", dpi = 300)
```


```r
get_metrics = function(truth_vector, predicted_class, model, num_rows, threshold=NA){
  cm = confusionMatrix(truth_vector, predicted_class, positive="Damaging")
  tp=cm$table[1]
  fn=cm$table[2]
  fp=cm$table[3]
  tn=cm$table[4]
  sensitivity=cm$byClass[1]
  specificity=cm$byClass[2]
  missingness = (num_rows-sum(cm$table))/num_rows * 100

  d = data.frame(tp=tp,fp=fp,fn=fn,tn=tn,missingness=missingness,sensitivity=sensitivity,specificity=specificity, threshold=threshold, model=model)
  rownames(d)=NULL
  d = as.data.frame(d)
  d$mcc = ((d$tp*d$tn) - (d$fp * d$fn)) / sqrt((as.numeric(d$tp + d$fp)*as.numeric(d$tp + d$fn)*as.numeric(d$tn + d$fp)*as.numeric(d$tn + d$fn)))
  return(d)
}
```

Calculate metrics on test set

```
##  Connection successful!
## 
## R is connected to the H2O cluster: 
##     H2O cluster uptime:         2 days 54 minutes 
##     H2O cluster timezone:       America/Chicago 
##     H2O data parsing timezone:  UTC 
##     H2O cluster version:        3.30.0.1 
##     H2O cluster version age:    3 months and 4 days  
##     H2O cluster name:           H2O_started_from_R_Steven_mzd115 
##     H2O cluster total nodes:    1 
##     H2O cluster total memory:   3.39 GB 
##     H2O cluster total cores:    8 
##     H2O cluster allowed cores:  8 
##     H2O cluster healthy:        TRUE 
##     H2O Connection ip:          localhost 
##     H2O Connection port:        54321 
##     H2O Connection proxy:       NA 
##     H2O Internal Security:      FALSE 
##     H2O API Extensions:         Amazon S3, Algos, AutoML, Core V3, TargetEncoder, Core V4 
##     R Version:                  R version 3.6.3 (2020-02-29) 
## 
##   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |   0%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |==============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================| 100%
##   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |   0%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |==============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================| 100%
```


```r
res_roc_2$RES$Gene='BRCA2'

for (i in 1:nrow(res_roc_2$RES)){
  model = res_roc_2$RES[i,'model']
  threshold = res_roc_2$RES[i,'threshold']
  num_rows = nrow(b2_DATA_SPLITS$test)

  if (model=='SiftScore'){
    tmp = b2_DATA_SPLITS$test %>% select_('Call', paste(model))
    names(tmp) = c('Call','Prediction')
    tmp = tmp %>% 
      mutate(Classification=ifelse(Prediction < threshold,'Damaging','Neutral')) %>%
      mutate(Classification=as.factor(Classification))
    tmp = get_metrics(tmp$Call, tmp$Classification, model, num_rows, threshold = threshold)
    tmp$Gene = 'BRCA2'
    metrics_table = rbind(metrics_table, tmp)
  }else if(model=='BRCA-ML'){
    tmp = test_model(b2_DATA_SPLITS, b2_TRAINED_DATA$model, threshold = threshold)
    tmp = get_metrics(tmp$result$Call, tmp$result$predict, 'BRCA-ML', num_rows, threshold = threshold)
    tmp$Gene = 'BRCA2'
    metrics_table = rbind(metrics_table, tmp)
    
  }else{
    tmp = b2_DATA_SPLITS$test %>% select_('Call', paste(model))
    names(tmp) = c('Call','Prediction')
    tmp = tmp %>% 
      mutate(Classification=ifelse(Prediction > threshold,'Damaging','Neutral')) %>%
      mutate(Classification=as.factor(Classification))
    tmp$Classification=factor(tmp$Classification,levels=c('Damaging','Neutral'))
    tmp = get_metrics(tmp$Call, tmp$Classification, model, num_rows, threshold = threshold)
    tmp$Gene = 'BRCA2'
    metrics_table = rbind(metrics_table, tmp)
  }
}
```

```
##  Connection successful!
## 
## R is connected to the H2O cluster: 
##     H2O cluster uptime:         2 days 54 minutes 
##     H2O cluster timezone:       America/Chicago 
##     H2O data parsing timezone:  UTC 
##     H2O cluster version:        3.30.0.1 
##     H2O cluster version age:    3 months and 4 days  
##     H2O cluster name:           H2O_started_from_R_Steven_mzd115 
##     H2O cluster total nodes:    1 
##     H2O cluster total memory:   3.39 GB 
##     H2O cluster total cores:    8 
##     H2O cluster allowed cores:  8 
##     H2O cluster healthy:        TRUE 
##     H2O Connection ip:          localhost 
##     H2O Connection port:        54321 
##     H2O Connection proxy:       NA 
##     H2O Internal Security:      FALSE 
##     H2O API Extensions:         Amazon S3, Algos, AutoML, Core V3, TargetEncoder, Core V4 
##     R Version:                  R version 3.6.3 (2020-02-29) 
## 
##   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |   0%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |==============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================| 100%
##   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |   0%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |==============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================| 100%
```

```r
rm(i, tmp)
```

Add confidence intervals

```r
add_ci = function(true1, false1, false2){
  correct = true1
  incorrect = sum(false1,false2)
  ci_ = tryCatch({
    res = prop.test(x = correct, n = incorrect, correct = FALSE)
    lci = round(res$conf.int[1],3)
    uci = round(res$conf.int[2],3)
    ci_ = paste(lci, uci, sep="-")
    return(ci_)
  },
  error=function(cond){
    return("-")
  }
  )
}
metrics_table$sensitivity_ci = NULL
metrics_table$specificity_ci = NULL
for (r in 1:nrow(metrics_table)){
  metrics_table$sensitivity_ci[r] = add_ci(metrics_table$tp[r], metrics_table$tp[r], metrics_table$fn[r])
  metrics_table$specificity_ci[r] = add_ci(metrics_table$tn[r], metrics_table$tn[r], metrics_table$fp[r])
}
```


```r
metrics_table %>% 
  filter(missingness < 1) %>%
  arrange(-mcc) %>%
  kable()
```



 tp   fp    fn    tn   missingness   sensitivity   specificity    threshold  model                            mcc  Gene    sensitivity_ci   specificity_ci 
---  ---  ----  ----  ------------  ------------  ------------  -----------  -----------------------  -----------  ------  ---------------  ---------------
 77    4    15   283     0.0000000     0.8369565     0.9860627    0.6533511  BRCA-ML                    0.8607840  BRCA1   0.748-0.899      0.965-0.995    
 14    1     2    24     0.0000000     0.8750000     0.9600000    0.5509820  BRCA-ML                    0.8456374  BRCA2   0.64-0.965       0.805-0.993    
 13    2     6    20     0.0000000     0.6842105     0.9090909    0.7396500  MetalrScore                0.6142303  BRCA2   0.46-0.846       0.722-0.975    
 11    4     4    22     0.0000000     0.7333333     0.8461538    0.2993765  BayesDel                   0.5794872  BRCA2   0.48-0.891       0.665-0.938    
 65   16    52   246     0.0000000     0.5555556     0.9389313    0.0105000  SiftScore                  0.5572469  BRCA1   0.465-0.642      0.903-0.962    
 12    3     6    20     0.0000000     0.6666667     0.8695652    0.5959500  MetasvmScore               0.5524850  BRCA2   0.437-0.837      0.679-0.955    
 66   15    57   241     0.0000000     0.5365854     0.9414062    0.8235000  Vest3Score                 0.5459366  BRCA1   0.449-0.622      0.906-0.964    
 70   11    72   226     0.0000000     0.4929577     0.9535865    0.2898460  BayesDel                   0.5272690  BRCA1   0.412-0.574      0.919-0.974    
 68   13    70   228     0.0000000     0.4927536     0.9460581    0.6865000  RevelScore                 0.5150811  BRCA1   0.411-0.575      0.91-0.968     
 12    3     7    19     0.0000000     0.6315789     0.8636364    0.6860000  RevelScore                 0.5126842  BRCA2   0.41-0.809       0.667-0.953    
 13    2     9    17     0.0000000     0.5909091     0.8947368    0.0005000  SiftScore                  0.5027772  BRCA2   0.387-0.767      0.686-0.971    
 64   15    69   229     0.5277045     0.4812030     0.9385246    0.1600000  AlignGVGDPrior             0.4927953  BRCA1   0.398-0.565      0.901-0.962    
 56   25    47   251     0.0000000     0.5436893     0.9094203    0.5838289  EigenRaw                   0.4917290  BRCA1   0.448-0.637      0.87-0.938     
 12    3     8    18     0.0000000     0.6000000     0.8571429    0.9995000  Polyphen2HvarScore         0.4743996  BRCA2   0.387-0.781      0.654-0.95     
 11    4     7    19     0.0000000     0.6111111     0.8260870    0.7920000  Vest3Score                 0.4504495  BRCA2   0.386-0.797      0.629-0.93     
 57   24    65   233     0.0000000     0.4672131     0.9066148    0.9985000  Polyphen2HvarScore         0.4260568  BRCA1   0.381-0.555      0.865-0.936    
 58   23    70   228     0.0000000     0.4531250     0.9083665    0.4995278  EigenPcRaw                 0.4170512  BRCA1   0.37-0.539       0.866-0.938    
  9    6     5    21     0.0000000     0.6428571     0.7777778    0.8083267  EigenRaw                   0.4141131  BRCA2   0.388-0.837      0.592-0.894    
 64   17    91   207     0.0000000     0.4129032     0.9241071    0.5199000  MetasvmScore               0.4041871  BRCA1   0.338-0.492      0.882-0.952    
 67   14   105   193     0.0000000     0.3895349     0.9323671    0.9995000  Polyphen2HdivScore         0.3909511  BRCA1   0.32-0.464       0.89-0.959     
 62   19    90   208     0.0000000     0.4078947     0.9162996    0.7238000  MetalrScore                0.3876051  BRCA1   0.333-0.487      0.873-0.946    
 13    2    13    13     0.0000000     0.5000000     0.8666667    5.3816765  CaddRaw                    0.3666667  BRCA2   0.321-0.679      0.621-0.963    
 76    5   150   148     0.0000000     0.3362832     0.9673203    4.3798810  CaddRaw                    0.3633758  BRCA1   0.278-0.4        0.926-0.986    
  8    7     6    20     0.0000000     0.5714286     0.7407407    1.0000000  GenocanyonScore            0.3073292  BRCA2   0.326-0.786      0.553-0.868    
 55   26   102   196     0.0000000     0.3503185     0.8828829    0.9063750  FathmmMklCodingScore       0.2802249  BRCA1   0.28-0.428       0.834-0.919    
 12    3    14    12     0.0000000     0.4615385     0.8000000    0.9999205  MutationtasterScore        0.2615385  BRCA2   0.288-0.645      0.548-0.93     
 12    3    14    12     0.0000000     0.4615385     0.8000000    0.9433700  FathmmMklCodingScore       0.2615385  BRCA2   0.288-0.645      0.548-0.93     
 66   15   150   148     0.0000000     0.3055556     0.9079755    0.0106923  GenocanyonScore            0.2578879  BRCA1   0.248-0.37       0.854-0.943    
  7    8     6    20     0.0000000     0.5384615     0.7142857    0.7388269  EigenPcRaw                 0.2441770  BRCA2   0.291-0.768      0.529-0.847    
 10    5    11    15     0.0000000     0.4761905     0.7500000    0.4750000  AlignGVGDPrior             0.2347290  BRCA2   0.283-0.676      0.531-0.888    
 74    7   208    90     0.0000000     0.2624113     0.9278351    0.9828861  DannScore                  0.2025239  BRCA1   0.215-0.317      0.858-0.965    
  2   13     1    25     0.0000000     0.6666667     0.6578947    0.7168295  Gm12878FitconsScore        0.1754757  BRCA2   0.208-0.939      0.499-0.788    
 29   52    70   228     0.0000000     0.2929293     0.8142857   -0.4050000  FathmmScore                0.1148951  BRCA1   0.212-0.389      0.765-0.855    
 81    0   297     1     0.0000000     0.2142857     1.0000000    0.9971410  MutationtasterScore        0.0268157  BRCA1   0.176-0.258      0.207-1        
  3   12     5    21     0.0000000     0.3750000     0.6363636    0.9987286  DannScore                  0.0093495  BRCA2   0.137-0.694      0.466-0.778    
 33   48   131   167     0.0000000     0.2012195     0.7767442    0.7172390  H1HescFitconsScore        -0.0266336  BRCA1   0.147-0.269      0.717-0.827    
 43   38   175   123     0.0000000     0.1972477     0.7639752    0.7064230  IntegratedFitconsScore    -0.0467591  BRCA1   0.15-0.255       0.693-0.823    
 49   32   203    95     0.0000000     0.1944444     0.7480315    0.6694520  HuvecFitconsScore         -0.0662371  BRCA1   0.15-0.248       0.666-0.815    
  2   13     5    21     0.0000000     0.2857143     0.6176471    0.6787490  IntegratedFitconsScore    -0.0754931  BRCA2   0.082-0.641      0.45-0.761     
 77    4   293     5     0.0000000     0.2081081     0.5555556    0.6789440  Gm12878FitconsScore       -0.0877813  BRCA1   0.17-0.252       0.267-0.811    
  7    8    15    11     0.0000000     0.3181818     0.5789474    0.6694520  HuvecFitconsScore         -0.1064996  BRCA2   0.164-0.527      0.363-0.769    
  1   14     6    20     0.0000000     0.1428571     0.5882353    0.6672555  H1HescFitconsScore        -0.2100677  BRCA2   0.026-0.513      0.422-0.736    
 16   65   177   121     0.0000000     0.0829016     0.6505376   -0.6850000  ProveanScore              -0.3250729  BRCA1   0.052-0.13       0.58-0.715     
  6    9    19     7     0.0000000     0.2400000     0.4375000    0.0000005  LrtScore                  -0.3266084  BRCA2   0.115-0.434      0.231-0.668    
 26   55   214    84     0.0000000     0.1083333     0.6043165    0.0003565  LrtScore                  -0.3378110  BRCA1   0.075-0.154      0.521-0.682    
  5   10    21     5     0.0000000     0.1923077     0.3333333   -1.8050000  ProveanScore              -0.4743590  BRCA2   0.085-0.379      0.152-0.583    
  3   12    19     7     0.0000000     0.1363636     0.3684211   -1.7250000  FathmmScore               -0.5126842  BRCA2   0.047-0.333      0.191-0.59     
 15    0    26     0     0.0000000     0.3658537            NA         -Inf  Polyphen2HdivScore               NaN  BRCA2   0.236-0.519      -              
  0   15     0    26     0.0000000            NA     0.6341463          Inf  Polyphen2HdivScore               NaN  BRCA2   -                0.481-0.764    



```r
model_list = as.character(metrics_table$model)[order(as.character(metrics_table$model))]
model_list = unique(model_list)
metrics_table$model = factor(metrics_table$model, levels=model_list)
metrics_table %>%  
  ggplot(aes(x=model, y=mcc, fill=Gene)) +
  geom_bar(stat='identity') +
  facet_grid(Gene~.) + 
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  ylab('MCC') +
  xlab('')
```

![](BRCA_ML_files/figure-html/unnamed-chunk-5-1.png)<!-- -->

```r
ggsave(filename = "results/MCC_plot.png", width = 14, height = 6, units = "in", dpi = 300)
```

Add HGVS Nomenclature

```r
NOMENCLATURE = read.csv('sources/Nomenclature',sep='\t')
TABLE_S2 = rbind(b1_PREDICTIONS, b2_PREDICTIONS)

TABLE_S2 = TABLE_S2 %>%
  merge(x=TABLE_S2, y=NOMENCLATURE, by.x='Variant', by.y='ID')
```


Save table S2.

```r
# Update BRCA-ML Label to contain a version number
version='1.1'
idx1=which(names(TABLE_S2)=='BRCA-ML')
idx2=which(names(TABLE_S2)=='Prediction')
names(TABLE_S2)[idx1] = paste('BRCA-ML', version, sep='.')
names(TABLE_S2)[idx2] = paste('BRCA-ML', version, 'Prediction', sep='.')

write.table(TABLE_S2, file='results/TableS2.tsv', sep='\t', row.names = FALSE)
```

Show Variable Importances for BRCA1

```r
b1_TRAINED_DATA$model@model$model_summary
```

```
## Model Summary: 
##   number_of_trees number_of_internal_trees model_size_in_bytes min_depth max_depth mean_depth min_leaves max_leaves mean_leaves
## 1              43                       43               17437         8        10    9.93023         18         35    27.44186
```

```r
kable(b1_TRAINED_DATA$vi)
```



variable                  relative_importance   scaled_importance   percentage
-----------------------  --------------------  ------------------  -----------
SiftScore                         228.6307678           1.0000000    0.2462698
BayesDel                          149.2628937           0.6528557    0.1607786
RevelScore                        111.8990250           0.4894312    0.1205321
Vest3Score                         78.9544373           0.3453360    0.0850458
MCapScore                          77.5852280           0.3393473    0.0835710
EigenRaw                           38.6547508           0.1690706    0.0416370
FathmmScore                        34.5862198           0.1512754    0.0372546
EigenPcRaw                         33.4357109           0.1462433    0.0360153
FathmmMklCodingScore               27.5602798           0.1205449    0.0296866
MetalrScore                        25.9263783           0.1133985    0.0279266
ProveanScore                       19.3794937           0.0847633    0.0208746
MetasvmScore                       16.7418938           0.0732268    0.0180335
GenocanyonScore                    14.2947884           0.0625235    0.0153976
CaddRaw                            12.6584997           0.0553666    0.0136351
MutpredScore                       10.8264103           0.0473533    0.0116617
AlignGVGDPrior                     10.3134680           0.0451097    0.0111092
HuvecFitconsScore                   9.5218487           0.0416473    0.0102565
IntegratedFitconsScore              9.2021122           0.0402488    0.0099121
DannScore                           7.2285023           0.0316165    0.0077862
Gm12878FitconsScore                 3.9566293           0.0173058    0.0042619
LrtScore                            2.7920721           0.0122121    0.0030075
H1HescFitconsScore                  2.7717595           0.0121233    0.0029856
MutationtasterScore                 1.3113272           0.0057356    0.0014125
Polyphen2HvarScore                  0.8359624           0.0036564    0.0009005
Polyphen2HdivScore                  0.0447302           0.0001956    0.0000482

Show Variable Importances for BRCA2

```r
b2_TRAINED_DATA$model@model$model_summary
```

```
## Model Summary: 
##   number_of_trees number_of_internal_trees model_size_in_bytes min_depth max_depth mean_depth min_leaves max_leaves mean_leaves
## 1              41                       41                5453         3         5    3.90244          5          7     5.92683
```

```r
kable(b2_TRAINED_DATA$vi)
```



variable                  relative_importance   scaled_importance   percentage
-----------------------  --------------------  ------------------  -----------
BayesDel                           76.7968063           1.0000000    0.4929590
MCapScore                          24.9095993           0.3243572    0.1598948
MutpredScore                       10.9259176           0.1422705    0.0701335
MetasvmScore                        5.3868966           0.0701448    0.0345785
EigenRaw                            5.0769749           0.0661092    0.0325891
RevelScore                          5.0708756           0.0660298    0.0325500
DannScore                           4.0285368           0.0524571    0.0258592
CaddRaw                             3.4012744           0.0442893    0.0218328
ProveanScore                        3.3169198           0.0431909    0.0212913
MetalrScore                         2.8846023           0.0375615    0.0185163
EigenPcRaw                          2.1957655           0.0285919    0.0140946
FathmmMklCodingScore                2.1749027           0.0283202    0.0139607
FathmmScore                         2.1013613           0.0273626    0.0134886
Gm12878FitconsScore                 2.0274644           0.0264004    0.0130143
Vest3Score                          2.0114865           0.0261923    0.0129117
GenocanyonScore                     1.4243219           0.0185466    0.0091427
Polyphen2HvarScore                  0.6220405           0.0080998    0.0039929
H1HescFitconsScore                  0.4576397           0.0059591    0.0029376
AlignGVGDPrior                      0.3325074           0.0043297    0.0021344
SiftScore                           0.2614248           0.0034041    0.0016781
HuvecFitconsScore                   0.1883577           0.0024527    0.0012091
MutationtasterScore                 0.1400472           0.0018236    0.0008990
LrtScore                            0.0517001           0.0006732    0.0003319
IntegratedFitconsScore              0.0000000           0.0000000    0.0000000
Polyphen2HdivScore                  0.0000000           0.0000000    0.0000000


```r
#save.image(file="working/v3.4_rel2.RData")
sessionInfo()
```

```
## R version 3.6.3 (2020-02-29)
## Platform: x86_64-w64-mingw32/x64 (64-bit)
## Running under: Windows 10 x64 (build 19041)
## 
## Matrix products: default
## 
## locale:
## [1] LC_COLLATE=English_United States.1252  LC_CTYPE=English_United States.1252    LC_MONETARY=English_United States.1252 LC_NUMERIC=C                           LC_TIME=English_United States.1252    
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
##  [1] knitr_1.28        e1071_1.7-3       ggpubr_0.3.0      PRROC_1.3.1       pROC_1.16.2       h2o_3.30.0.1      caret_6.0-86      lattice_0.20-38   data.table_1.12.8 forcats_0.5.0     stringr_1.4.0     dplyr_0.8.5       purrr_0.3.3       readr_1.3.1       tidyr_1.0.2       tibble_3.0.0      ggplot2_3.3.0     tidyverse_1.3.0  
## 
## loaded via a namespace (and not attached):
##  [1] nlme_3.1-144         bitops_1.0-6         fs_1.4.0             lubridate_1.7.4      httr_1.4.1           tools_3.6.3          backports_1.1.5      R6_2.4.1             rpart_4.1-15         mgcv_1.8-31          DBI_1.1.0            colorspace_1.4-1     nnet_7.3-12          withr_2.1.2          gridExtra_2.3        tidyselect_1.0.0     curl_4.3             compiler_3.6.3       cli_2.0.2            rvest_0.3.5          xml2_1.3.0           labeling_0.3         scales_1.1.0         digest_0.6.25        foreign_0.8-75       rmarkdown_2.1        rio_0.5.16           pkgconfig_2.0.3      htmltools_0.4.0      highr_0.8            dbplyr_1.4.2         rlang_0.4.5          readxl_1.3.1         rstudioapi_0.11      farver_2.0.3         generics_0.0.2       jsonlite_1.6.1       zip_2.0.4            ModelMetrics_1.2.2.2 car_3.0-8            RCurl_1.98-1.1       magrittr_1.5         Matrix_1.2-18        Rcpp_1.0.4           munsell_0.5.0        fansi_0.4.1          abind_1.4-5          lifecycle_0.2.0      stringi_1.4.6        yaml_2.2.1           carData_3.0-4        MASS_7.3-51.5        plyr_1.8.6           recipes_0.1.12       grid_3.6.3           crayon_1.3.4         cowplot_1.0.0        haven_2.2.0          splines_3.6.3        hms_0.5.3            pillar_1.4.3         ggsignif_0.6.0       reshape2_1.4.3       codetools_0.2-16     stats4_3.6.3         reprex_0.3.0         glue_1.4.1           evaluate_0.14        modelr_0.1.6         vctrs_0.2.4          foreach_1.5.0        cellranger_1.1.0     gtable_0.3.0         assertthat_0.2.1     openxlsx_4.1.5       xfun_0.12            gower_0.2.1          prodlim_2019.11.13   broom_0.5.5          rstatix_0.5.0        class_7.3-15         survival_3.1-8       timeDate_3043.102    iterators_1.0.12     lava_1.6.7          
## [86] ellipsis_0.3.0       ipred_0.9-9
```
